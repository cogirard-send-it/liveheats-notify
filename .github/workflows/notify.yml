name: LiveHeats Notify

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Choose run mode"
        required: true
        type: choice
        options:
          - send-once
          - looped-updates
        default: send-once
      event_id:
        description: "LiveHeats event ID"
        required: true
        type: string
      message:
        description: "Optional message override"
        required: false
        type: string

permissions:
  contents: read

jobs:
  send-once:
    if: ${{ inputs.mode == 'send-once' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci || npm i

      - name: Send push once
        env:
          VAPID_SUBJECT: "mailto:you@example.com"
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          EVENT_ID: ${{ inputs.event_id }}
          MESSAGE_OVERRIDE: ${{ inputs.message }}
          SUBSCRIPTIONS_FILE: "data/subscriptions.json"
        run: node notifier/notify.js

  looped-updates:
    if: ${{ inputs.mode == 'looped-updates' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci || npm i

      - name: Loop send every 30s
        env:
          VAPID_SUBJECT: "mailto:you@example.com"
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          EVENT_ID: ${{ inputs.event_id }}
          MESSAGE_OVERRIDE: ${{ inputs.message }}
          SUBSCRIPTIONS_FILE: "data/subscriptions.json"
        run: |
          START=$(date +%s)
          DURATION=$((25*60))
          while true; do
            echo "=== sending ==="
            node notifier/notify.js || echo "notify.js error"
            sleep 30
            NOW=$(date +%s)
            [ $((NOW-START)) -ge $DURATION ] && break
          done
``
