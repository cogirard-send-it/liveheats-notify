<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LiveHeats Notifier</title>

  <!-- âœ… REAL manifest link under your GitHub Pages subpath -->
  <link rel="manifest" href="/liveheats-notify/manifest.json?v=5">

  <!-- iOS PWA meta -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="LiveHeats">
  <meta name="theme-color" content="#ffffff">

  <style>
    body { font-family: -apple-system, system-ui, Arial, sans-serif; padding: 24px; }
    button { padding: 10px 16px; font-size: 16px; }
    #status { margin-top: 16px; font-weight: 600; white-space: pre-line; }
    .muted { color: #666; font-size: 14px; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
  </style>
</head>

<body>
  <h2>LiveHeats iPhone Notifier</h2>
  <p class="muted">Open from your <strong>iPhone Home Screen</strong> (not a Safari tab), then tap the button.</p>

  <button id="btn-sub">Enable Notifications</button>
  <div id="status"></div>

  <script>
    // Helper: append status lines on screen for easy debugging on iPhone
    function log(line, cls = '') {
      const el = document.getElementById('status');
      const span = document.createElement('div');
      if (cls) span.className = cls;
      span.textContent = line;
      el.appendChild(span);
      console.log(line);
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    async function ensureServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        log('Service Worker not supported', 'err');
        return null;
      }
      try {
        // Register SW under the repo subpath with a cache-busting query
        const reg = await navigator.serviceWorker.register('/liveheats-notify/service-worker.js?v=5', {
          scope: '/liveheats-notify/'
        });
        log('SW registered');
        return reg;
      } catch (e) {
        console.error(e);
        log('SW registration failed: ' + (e && e.message ? e.message : e), 'err');
        return null;
      }
    }

    async function subscribe() {
      try {
        if (!window.isSecureContext) {
          log('This page is not in a secure context (https required)', 'err');
          return;
        }
        log('Starting subscribe flow...');

        const reg = await ensureServiceWorker();
        if (!reg) return;

        const permission = await Notification.requestPermission();
        log('Permission result: ' + permission);
        if (permission !== 'granted') {
          log('Notifications not granted', 'err');
          return;
        }

        // Your PUBLIC VAPID KEY (from your last message)
        const PUBLIC_VAPID_KEY = 'BD8LRWjR5B2Act8otJlkgVP3orYr82YNO_abU79qidkccM02nb7XLr3lcSAI7km6di62bMdNJBFFz2OFZktW9ok';
        const applicationServerKey = urlBase64ToUint8Array(PUBLIC_VAPID_KEY);

        const existing = await reg.pushManager.getSubscription();
        if (existing) {
          log('Already subscribed', 'ok');
          console.log('Existing subscription:', JSON.stringify(existing));
          return;
        }

        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey
        });

        log('Subscribed! (backend wiring next)', 'ok');
        console.log('Push subscription:', JSON.stringify(sub));
        // TODO: send `sub` to your backend in the next step
      } catch (err) {
        console.error(err);
        log('Subscription failed: ' + (err && err.message ? err.message : err), 'err');
      }
    }

    document.getElementById('btn-sub').addEventListener('click', subscribe);
  </script>
</body>
</html>
