<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LiveHeats iPhone Notifier</title>

  <!-- Correct PWA manifest link (GitHub Pages under /liveheats-notify/) -->
  <link rel="manifest" href="/liveheats-notify/manifest.json?v=13">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="LiveHeats">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root { color-scheme: light dark; }
    body { font-family:-apple-system, system-ui, Arial, sans-serif; padding:24px; }
    #diag {
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: #eef6ff; color:#0b3b85; border:1px solid #cde3ff;
      padding:10px; border-radius:8px; margin-bottom:12px; white-space:pre-wrap;
    }
    label { display:block; margin:16px 0 6px; font-weight:600; }
    input[type="text"] { width:100%; padding:10px; font-size:16px; box-sizing:border-box; }
    button { padding:10px 14px; font-size:16px; margin-right:8px; margin-top:10px; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    #status { margin-top:18px; font-weight:600; white-space:pre-line; }
    .muted { color:#666; font-size:14px; }
    .ok { color:#0a7a0a; }
    .err { color:#b00020; }
    pre {

  <pre id="sub-json"></pre>
  <div id="status" class="muted">Bootingâ€¦</div>

  <script>
    // ðŸ” Your VAPID public key (Base64URL)
    const VAPID_PUBLIC_KEY =
      "BFeoeR2lmssJq5k8_wPuC1FJEk0OWZnwqDWksnzsR200b0BAPZoXdswK02ryxAhgDInbyifNnP1mHM5mAOhJ1UI";

    // Element refs
    const $diag = document.getElementById("diag");
    const $status = document.getElementById("status");
    const $eventId = document.getElementById("event-id");
    const $openEvent = document.getElementById("open-event");
    const $subBox = document.getElementById("sub-json");
    const $btnEnable = document.getElementById("enable-push");
    const $btnTest   = document.getElementById("test-local");
    const $btnShow   = document.getElementById("show-sub");
    const $btnCopy   = document.getElementById("copy-sub");

    // Restore saved Event ID
    const saved = localStorage.getItem("lh_event_id") || "";
    if (saved) $eventId.value = saved;
    updateOpenLink();

    document.getElementById("save-event").onclick = () => {
      const v = ($eventId.value || "").trim();
      if (!v) return setStatus("Please enter an Event ID.", true);
      localStorage.setItem("lh_event_id", v);
      updateOpenLink();
      setStatus(`Saved Event ID ${v}`, false);
    };

    function updateOpenLink() {
      const id = ($eventId.value || "").trim();
      $openEvent.href = id ? `https://liveheats.com/events/${id}/schedule` : "#";
      $openEvent.textContent = id
        ? `Open liveheats.com/events/${id}/schedule`
        : "Open event page";
    }

    function setStatus(msg, isErr) {
      $status.classList.toggle("ok", !isErr);
      $status.classList.toggle("err", !!isErr);
      $status.textContent = msg;
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    function isIOSStandalone() {
  </style>
</head>

<body>
  <h2>LiveHeats iPhone Notifier</h2>
  <p class="muted">
    Open this app from your <strong>iPhone Home Screen</strong> (not in a Safari tab).
  </p>

  <!-- Event ID -->
  <label for="event-id">Event ID</label>
  <input id="event-id" type="text" inputmode="numeric" placeholder="e.g., 468713" />

  <div>
    <button id="save-event">Save event</button>
    <a id="open-event" target="_blank" rel="noopener">Open event page</a>
  </div>

  <!-- Notifications -->
  <label>Notifications</label>
  <div>
    <button id="enable-push">Enable notifications</button>
    <button id="test-local">Test local notification</button>
    <button id="show-sub">Show subscription</button>
    <button id="copy-sub">Copy</button>
  </div>

  <pre id="sub-json"></pre>

  <div id="status" class="muted">Ready.</div>

  <script>
    // ðŸ” Your exact VAPID public key
    const VAPID_PUBLIC_KEY =
      "BFeoeR2lmssJq5k8_wPuC1FJEk0OWZnwqDWksnzsR200b0BAPZoXdswK02ryxAhgDInbyifNnP1mHM5mAOhJ1UI";

    // UI refs
    const $status = document.getElementById("status");
    const $eventId = document.getElementById("event-id");
    const $openEvent = document.getElementById("open-event");
    const $subBox = document.getElementById("sub-json");

    // Load saved event ID
    const saved = localStorage.getItem("lh_event_id") || "";
    if (saved) $eventId.value = saved;
    updateOpenLink();

    // Save event ID
    document.getElementById("save-event").onclick = () => {
      const v = ($eventId.value || "").trim();
      if (!v) return setStatus("Please enter an Event ID.", true);
    <button id="test-local">Test local notification</button>
    <button id="show-sub">Show subscription</button>
    <button id="copy-sub">Copy</button>
  </div>

  <pre id="sub-json"></pre>
  <div id="status" class="muted">Ready.</div>

  <script>
    const VAPID_PUBLIC_KEY = 'BD278lRSLEagvve9NFAiS-v1kPLLtk-Vv_w42rJIRB44PfxvESM9--BR4UKUkVyo3fC5GQbrJ8hDz2nrX-xMN28';
    const $status=document.getElementById('status');
    const $eventId=document.getElementById('event-id');
    const $openEvent=document.getElementById('open-event');
    const $subBox=document.getElementById('sub-json');

    const saved=localStorage.getItem('lh_event_id')||''; if(saved) $eventId.value=saved; updateOpenLink();
    document.getElementById('save-event').onclick=()=>{const v=($eventId.value||'').trim();
      if(!v) return setStatus('Please enter an Event ID.',true);
      localStorage.setItem('lh_event_id',v); updateOpenLink(); setStatus(`Saved Event ID ${v}`,false);};
    function updateOpenLink(){const id=($eventId.value||'').trim();
      $openEvent.href=id?`https://liveheats.com/events/${id}/schedule`:'#';
      $openEvent.textContent=id?`Open liveheats.com/events/${id}/schedule`:'Open event page';}
    function setStatus(m,e){$status.classList.toggle('ok',!e);$status.classList.toggle('err',!!e);$status.textContent=m;}

    // Register Service Worker (version bump to bust cache)
    window.addEventListener('load', async () => {
      if(!('serviceWorker' in navigator)) return setStatus('Service workers not supported here.',true);
      try{
        const reg=await navigator.serviceWorker.register('/liveheats-notify/service-worker.js?v=11',{scope:'/liveheats-notify/'});
        setStatus('Service worker ready.',false); window.__swReg=reg;
      }catch{ setStatus('Failed to register service worker.',true); }
    });

    // Enable push (must be a user gesture)
    document.getElementById('enable-push').onclick=async()=>{
      try{
        if(!window.__swReg) throw new Error('SW not ready yet');
        const perm=await Notification.requestPermission();
        if(perm!=='granted') return setStatus('Permission was not granted.',true);
        const sub=await window.__swReg.pushManager.subscribe({
          userVisibleOnly:true,
          applicationServerKey:urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        localStorage.setItem('lh_sub', JSON.stringify(sub));
        setStatus('Notifications enabled. Subscription saved locally.',false);
      }catch(e){ setStatus('Failed to enable push: '+e.message,true); }
    };

    // Local visible test
    document.getElementById('test-local').onclick=async()=>{
      if(!window.__swReg) return setStatus('SW not ready.',true);
      const id=localStorage.getItem('lh_event_id')||'â€”';
      await window.__swReg.showNotification('LiveHeats Test',{
        body:`Local test for event ${id}`,
        icon:'/liveheats-notify/icon.png',
        data:{ url:`https://liveheats.com/events/${id}/schedule` }
      });
      setStatus('Local notification shown.',false);
    };

    // View/Copy subscription (so we can paste it into the repo)
    document.getElementById('show-sub').onclick=()=>{
      const s=localStorage.getItem('lh_sub');
      if(!s) return setStatus('No subscription found. Tap Enable notifications first.',true);
      $subBox.textContent=s; $subBox.style.display='block';
    };
    document.getElementById('copy-sub').onclick=async()=>{
      const s=$subBox.textContent || localStorage.getItem('lh_sub');
      if(!s) return setStatus('Nothing to copy. Tap Show subscription first.',true);
      try{ await navigator.clipboard.writeText(s); setStatus('Copied subscription to clipboard.',false); }
      catch{ setStatus('Copy failed. Long-press the text and select Copy instead.',true); }
    };

    function urlBase64ToUint8Array(b){const p='='.repeat((4-(b.length%4))%4);const base=(b+p).replace(/\-/g,'+').replace(/_/g,'/');const raw=atob(base);
      const out=new Uint8Array(raw.length); for(let i=0;i<raw.length;++i) out[i]=raw.charCodeAt(i); return out;}
  </script>
</body>
</html>
