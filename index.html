<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LiveHeats iPhone Notifier</title>

  <link rel="manifest" href="/liveheats-notify/manifest.json?v=9" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="LiveHeats">
  <meta name="theme-color" content="#ffffff">
  <style>
    body { font-family: -apple-system, system-ui, Arial, sans-serif; padding: 24px; }
    label { display: block; margin: 16px 0 6px; font-weight: 600; }
    input[type="text"] { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    button { padding: 10px 14px; font-size: 16px; margin-right: 8px; margin-top: 10px; }
    #status { margin-top: 18px; font-weight: 600; white-space: pre-line; }
    .muted { color: #666; font-size: 14px; }
    .ok { color: #0a7a0a; } .err { color: #b00020; }
  </style>
</head>
<body>
  <h2>LiveHeats iPhone Notifier</h2>
  <p class="muted">Open from your <strong>iPhone Home Screen</strong> (not a Safari tab). Then set the event and enable notifications.</p>

  <label for="event-id">Event ID</label>
  <input id="event-id" type="text" inputmode="numeric" placeholder="e.g., 470198" />
  <div>
    <button id="save-event">Save event</button>
    <a id="open-event" target="_blank" rel="noopener">Open event page</a>
  </div>

  <label>Notifications</label>
  <div>
    <button id="enable-push">Enable notifications</button>
    <button id="test-local">Test local notification</button>
  </div>

  <div id="status" class="muted">Ready.</div>

  <script>
    // Your PUBLIC VAPID key
    const VAPID_PUBLIC_KEY = 'BD278lRSLEagvve9NFAiS-v1kPLLtk-Vv_w42rJIRB44PfxvESM9--BR4UKUkVyo3fC5GQbrJ8hDz2nrX-xMN28';

    const $status = document.getElementById('status');
    const $eventId = document.getElementById('event-id');
    const $openEvent = document.getElementById('open-event');

    // Load saved event id
    const saved = localStorage.getItem('lh_event_id') || '';
    if (saved) $eventId.value = saved;
    updateOpenLink();

    document.getElementById('save-event').onclick = () => {
      const val = ($eventId.value || '').trim();
      if (!val) return setStatus('Please enter an Event ID.', true);
      localStorage.setItem('lh_event_id', val);
      updateOpenLink();
      setStatus(`Saved Event ID ${val}`, false);
    };

    function updateOpenLink() {
      const id = ($eventId.value || '').trim();
      $openEvent.href = id ? `https://liveheats.com/events/${id}` : '#';
      $openEvent.textContent = id ? `Open liveheats.com/events/${id}` : 'Open event page';
    }
    function setStatus(msg, isErr) {
      $status.classList.toggle('ok', !isErr);
      $status.classList.toggle('err', !!isErr);
      $status.textContent = msg;
    }

    // SW
    window.addEventListener('load', async () => {
      if (!('serviceWorker' in navigator)) return setStatus('Service workers not supported here.', true);
      try {
        const reg = await navigator.serviceWorker.register('/liveheats-notify/service-worker.js?v=8', { scope: '/liveheats-notify/' });
        setStatus('Service worker ready.', false);
        window.__swReg = reg;
      } catch {
        setStatus('Failed to register service worker.', true);
      }
    });

    // Enable push
    document.getElementById('enable-push').onclick = async () => {
      try {
        if (!window.__swReg) throw new Error('SW not ready yet');
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return setStatus('Permission was not granted.', true);
        const sub = await window.__swReg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        // TODO: POST `sub` to your backend to save
        console.log('PushSubscription:', sub);
        setStatus('Notifications enabled. Subscription printed to console.', false);
      } catch (e) {
        setStatus('Failed to enable push: ' + e.message, true);
      }
    };

    // Local test
    document.getElementById('test-local').onclick = async () => {
      if (!window.__swReg) return setStatus('SW not ready.', true);
      const id = localStorage.getItem('lh_event_id') || 'â€”';
      await window.__swReg.showNotification('LiveHeats Test', {
        body: `Local test for event ${id}`,
        icon: '/liveheats-notify/icon.png',
        data: { url: `https://liveheats.com/events/${id}` }
      });
      setStatus('Local notification shown.', false);
    };

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }
  </script>
</body>
</html>
